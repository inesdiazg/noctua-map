---
title: "Puntos de muestreo con grabadora - NOCTUA 2024"
lang: es
---

### Resumen de la temporada:

```{r, echo= FALSE}
library(leaflet)
library(glue)
library(htmltools)
library(sf)
library(dplyr)

ptos <- read.csv("datos/noctua.csv", sep = ";")
ptos <- ptos %>%
  mutate(PuntoMuestreo = gsub("_", " ", PuntoMuestreo))

resumen_html <- glue(
  "<ul>
    <li><b>Total de grabadoras:</b> {length(unique(ptos$Grabadora.ID))}</li>
    <li><b>Número de responsables:</b> {length(unique(ptos$Responsable))}</li>
    <li><b>Cuadrículas UTM cubiertas:</b> {length(unique(ptos$UTM10_Asignada))}</li>
    <li><b>Noches grabadas:</b> {round(mean(ptos$Dias_Grabados_Campo),1)} de media 
    (mínimo: {min(ptos$Dias_Grabados_Campo)}, máximo: {max(ptos$Dias_Grabados_Campo)})</li>
  </ul>"
)

HTML(resumen_html)
```

### Mapa

Haz clic en los iconos ![](images/marker-icon.png){width="16"} para ver la información sobre los puntos de muestreo.

```{r, echo= FALSE}

ptos_sf <- st_as_sf(ptos, coords = c("Longitud", "Latitud"), crs = 4326)

# 2️⃣ Cargar cuadrículas
cuadrillas <- st_read("datos/Malla10x10_Ter_p.shp") %>%
  st_transform(crs = 4326)

# 3️⃣ Unión espacial: asignar cada punto a la cuadrícula donde cae
ptos_con_cuadrilla <- st_join(ptos_sf, cuadrillas, join = st_within)

# 4️⃣ Crear HTML de popup transpuesto
popup_html <- ptos_con_cuadrilla %>%
  st_set_geometry(NULL) %>%
  group_by(UTMCODE) %>%
  summarise(
    popup = {
      # Datos de cada punto
      puntos <- PuntoMuestreo
      provincias <- Provincia
      inicio <- FechaInicioGrabacionMuestreo
      fin <- FechaFinGrabacionMuestreo
      noches <- Dias_Grabados_Campo
      habitat <- Habitat
      
      # Cabeceras con ancho mínimo y padding
      columnas <- paste0(
        "<th style='padding:4px 12px; min-width:100px;'>", puntos, "</th>", 
        collapse = ""
      )
      
      # Filas con mismo estilo
      fila_provincia <- paste0("<td style='padding:4px 12px; min-width:100px;'>", provincias, "</td>", collapse = "")
      fila_inicio    <- paste0("<td style='padding:4px 12px; min-width:100px;'>", inicio, "</td>", collapse = "")
      fila_fin       <- paste0("<td style='padding:4px 12px; min-width:100px;'>", fin, "</td>", collapse = "")
      fila_noches    <- paste0("<td style='padding:4px 12px; min-width:100px;'>", noches, "</td>", collapse = "")
      fila_habitat   <- paste0("<td style='padding:4px 12px; min-width:100px;'>", habitat, "</td>", collapse = "")
      
      # Tabla con borde y estilo
      paste0(
        "<table style='border-collapse: collapse; width: 100%; border: 1px solid #ccc;'>",
        "<tr style='background-color:#f0f0f0;'><th style='padding:4px 12px;'></th>", columnas, "</tr>",
        "<tr><th style='padding:4px 12px;'>Provincia</th>", fila_provincia, "</tr>",
        "<tr><th style='padding:4px 12px;'>Inicio</th>", fila_inicio, "</tr>",
        "<tr><th style='padding:4px 12px;'>Fin</th>", fila_fin, "</tr>",
        "<tr><th style='padding:4px 12px;'>Noches</th>", fila_noches, "</tr>",
        "<tr><th style='padding:4px 12px;'>Hábitat</th>", fila_habitat, "</tr>",
        "</table>"
      )
    },
    .groups = "drop"
  )

# 5️⃣ Unir info de popup a polígonos
cuad_con_info <- cuadrillas %>%
  inner_join(popup_html, by = "UTMCODE")

# 6️⃣ Crear mapa Leaflet
leaflet(cuad_con_info) %>%
  addTiles() %>%
  setView(lng = -3.7, lat = 40.4, zoom = 5) %>%
  addPolygons(
    fillOpacity = 0.1,
    color = "blue",
    weight = 1,
    popup = ~popup
  )

```
